<template>
  <view class="u-dropdown">
    <view
      class="u-dropdown__menu"
      :style="{
        height: $u.addUnit(height),
      }"
      :class="{
        'u-border-bottom': borderBottom,
      }"
    >
      <view
        class="u-dropdown__menu__item"
        v-for="(item, index) in menuList"
        :key="index"
        @tap.stop="menuClick(index)"
      >
        <view class="u-flex">
          <text
            class="u-dropdown__menu__item__text"
            :style="{
              color: item.disabled
                ? '#c0c4cc'
                : index === current || highlightIndex == index
                ? activeColor
                : inactiveColor,
              fontSize: $u.addUnit(titleSize),
            }"
            >{{ item.title }}</text
          >
          <view
            class="u-dropdown__menu__item__arrow"
            :class="{
              'u-dropdown__menu__item__arrow--rotate': index === current,
            }"
          >
            <u-icon
              :custom-style="{ display: 'flex' }"
              :name="menuIcon"
              :size="$u.addUnit(menuIconSize)"
              :color="index === current || highlightIndex == index ? activeColor : '#c0c4cc'"
            ></u-icon>
          </view>
        </view>
      </view>
    </view>
    <view
      class="u-dropdown__content"
      :style="[
        contentStyle,
        {
          transition: `opacity ${duration / 1000}s linear`,
          top: $u.addUnit(height),
          height: contentHeight + 'px',
        },
      ]"
      @tap="maskClick"
      @touchmove.stop.prevent
    >
      <view @tap.stop.prevent class="u-dropdown__content__popup" :style="popupStyle">
        <slot></slot>
      </view>
      <view class="u-dropdown__content__mask"></view>
    </view>
  </view>
</template>

<script lang='ts'>
/**
 * dropdown 下拉菜单
 * @description 该组件一般用于向下展开菜单，同时可切换多个选项卡的场景
 * @tutorial http://uviewui.com/components/dropdown.html
 * @property {String} active-color 标题和选项卡选中的颜色（默认#2abc6d）
 * @property {String} inactive-color 标题和选项卡未选中的颜色（默认#606266）
 * @property {Boolean} close-on-click-mask 点击遮罩是否关闭菜单（默认true）
 * @property {Boolean} close-on-click-self 点击当前激活项标题是否关闭菜单（默认true）
 * @property {String | Number} duration 选项卡展开和收起的过渡时间，单位ms（默认300）
 * @property {String | Number} height 标题菜单的高度，单位任意（默认80）
 * @property {String | Number} border-radius 菜单展开内容下方的圆角值，单位任意（默认0）
 * @property {Boolean} border-bottom 标题菜单是否显示下边框（默认false）
 * @property {String | Number} title-size 标题的字体大小，单位任意，数值默认为rpx单位（默认28）
 * @event {Function} open 下拉菜单被打开时触发
 * @event {Function} close 下拉菜单被关闭时触发
 * @example <u-dropdown></u-dropdown>
 */
import { defineComponent, onMounted, computed, reactive, toRefs } from "vue";
import { addUnit } from "../../libs/function/addUnit";
import { sys } from "../../libs/function/sys";
import { styleObjToString } from "../../libs/function/styleObjToString";

let instanceProxy: any;

export default defineComponent({
  name: "u-dropdown",

  props: {
    // 菜单标题和选项的激活态颜色
    activeColor: {
      type: String,
      default: "#2abc6d",
    },
    // 菜单标题和选项的未激活态颜色
    inactiveColor: {
      type: String,
      default: "#606266",
    },
    // 点击遮罩是否关闭菜单
    closeOnClickMask: {
      type: Boolean,
      default: true,
    },
    // 点击当前激活项标题是否关闭菜单
    closeOnClickSelf: {
      type: Boolean,
      default: true,
    },
    // 过渡时间
    duration: {
      type: [Number, String],
      default: 300,
    },
    // 标题菜单的高度，单位任意，数值默认为rpx单位
    height: {
      type: [Number, String],
      default: 80,
    },
    // 是否显示下边框
    borderBottom: {
      type: Boolean,
      default: false,
    },
    // 标题的字体大小
    titleSize: {
      type: [Number, String],
      default: 28,
    },
    // 下拉出来的内容部分的圆角值
    borderRadius: {
      type: [Number, String],
      default: 0,
    },
    // 菜单右侧的icon图标
    menuIcon: {
      type: String,
      default: "arrow-down",
    },
    // 菜单右侧图标的大小
    menuIconSize: {
      type: [Number, String],
      default: 26,
    },
  },

  emits: ["open", "close"],

  setup(props: any, { emit }) {
    let state = reactive({
      showDropdown: true, // 是否打开下来菜单,
      menuList: [] as any, // 显示的菜单
      active: false, // 下拉菜单的状态
      // 当前是第几个菜单处于激活状态，小程序中此处不能写成false或者""，否则后续将current赋值为0，
      // 无能的TX没有使用===而是使用==判断，导致程序认为前后二者没有变化，从而不会触发视图更新
      current: 99999,
      // 外层内容的样式，初始时处于底层，且透明
      contentStyle: {
        zIndex: -1,
        opacity: 0,
      } as any,
      // 让某个菜单保持高亮的状态
      highlightIndex: 99999 as any,
      contentHeight: 0,
      children: [],
    });

    // 引用所有子组件(u-dropdown-item)的this，不能在data中声明变量，否则在微信小程序会造成循环引用而报错
    // this.children = [];

    onMounted(() => {
      getContentHeight();
    });

    // 下拉出来部分的样式
    const popupStyle = computed(() => {
      let style: any = {};
      // 进行Y轴位移，展开状态时，恢复原位。收齐状态时，往上位移100%，进行隐藏
      style.transform = `translateY(${state.active ? 0 : "-100%"})`;
      style["transition-duration"] = props.duration / 1000 + "s";
      style["border-radius"] = `0 0 ${addUnit(props.borderRadius)} ${addUnit(props.borderRadius)}`;
      return styleObjToString(style);
    });

    function init() {
      // 当某个子组件内容变化时，触发父组件的init，父组件再让每一个子组件重新初始化一遍
      // 以保证数据的正确性
      state.menuList = [];
      state.children.map((child: any) => {
        child.init();
      });
    }

    // 点击菜单
    function menuClick(index: any) {
      // 判断是否被禁用
      if (state.menuList[index].disabled) return;
      // 如果点击时的索引和当前激活项索引相同，意味着点击了激活项，需要收起下拉菜单
      if (index === state.current && props.closeOnClickSelf) {
        close();
        // 等动画结束后，再移除下拉菜单中的内容，否则直接移除，也就没有下拉菜单收起的效果了
        setTimeout(() => {
          (state.children[index] as any).active = false;
        }, props.duration);
        return;
      }
      open(index);
    }

    // 打开下拉菜单
    function open(index) {
      // 重置高亮索引，否则会造成多个菜单同时高亮
      // this.highlightIndex = 9999;
      // 展开时，设置下拉内容的样式
      state.contentStyle = {
        zIndex: 11,
      };
      // 标记展开状态以及当前展开项的索引
      state.active = true;
      state.current = index;
      // 历遍所有的子元素，将索引匹配的项标记为激活状态，因为子元素是通过v-if控制切换的
      // 之所以不是因display: none，是因为nvue没有display这个属性
      state.children.map((val: any, idx) => {
        val.active = index == idx ? true : false;
      });
      emit("open", state.current);
    }

    // 设置下拉菜单处于收起状态
    function close() {
      emit("close", state.current);
      // 设置为收起状态，同时current归位，设置为空字符串
      state.active = false;
      state.current = 99999;
      // 下拉内容的样式进行调整，不透明度设置为0
      state.contentStyle = {
        zIndex: -1,
        opacity: 0,
      };
    }

    // 点击遮罩
    function maskClick() {
      // 如果不允许点击遮罩，直接返回
      if (!props.closeOnClickMask) return;
      close();
    }

    // 外部手动设置某个菜单高亮
    function highlight(index = undefined) {
      state.highlightIndex = index !== undefined ? index : 99999;
    }

    // 获取下拉菜单内容的高度
    function getContentHeight() {
      // 这里的原理为，因为dropdown组件是相对定位的，它的下拉出来的内容，必须给定一个高度
      // 才能让遮罩占满菜单一下，直到屏幕底部的高度
      // this.$u.sys()为uView封装的获取设备信息的方法
      let windowHeight = sys.sys().windowHeight;
      instanceProxy &&
        instanceProxy.$uGetRect(".u-dropdown__menu").then((res) => {
          // 这里获取的是dropdown的尺寸，在H5上，uniapp获取尺寸是有bug的(以前提出修复过，后来又出现了此bug，目前hx2.8.11版本)
          // H5端bug表现为元素尺寸的top值为导航栏底部到到元素的上边沿的距离，但是元素的bottom值确是导航栏顶部到元素底部的距离
          // 二者是互相矛盾的，本质原因是H5端导航栏非原生，uni的开发者大意造成
          // 这里取菜单栏的botton值合理的，不能用res.top，否则页面会造成滚动
          state.contentHeight = windowHeight - res.bottom;
        });
    }

    return {
      ...toRefs(state),
      ...toRefs(props),
      popupStyle,
      init,
      menuClick,
      open,
      close,
      maskClick,
      highlight,
      getContentHeight,
    };
  },

  mounted() {
    instanceProxy = this;
  },
});
</script>

<style scoped lang="scss">
@import "../../libs/css/style.components.scss";

.u-dropdown {
  position: relative;
  flex: 1;
  width: 100%;

  &__menu {
    @include vue-flex;

    position: relative;
    z-index: 11;
    height: 80rpx;

    &__item {
      flex: 1;
      align-items: center;
      justify-content: center;
      @include vue-flex;

      &__text {
        font-size: 28rpx;
        color: $u-content-color;
      }

      &__arrow {
        align-items: center;
        margin-left: 6rpx;
        transition: transform 0.3s;
        @include vue-flex;

        &--rotate {
          transform: rotate(180deg);
        }
      }
    }
  }

  &__content {
    position: absolute;
    bottom: 0;
    left: 0;
    z-index: 8;
    width: 100%;
    overflow: hidden;

    &__mask {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 9;
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
    }

    &__popup {
      position: relative;
      z-index: 10;
      overflow: hidden;
      transition: all 0.3s;
      transform: translate3d(0, -100%, 0);
    }
  }
}
</style>
