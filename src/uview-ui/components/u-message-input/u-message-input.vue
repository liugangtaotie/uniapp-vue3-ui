<template>
  <view class="u-char-box">
    <view class="u-char-flex">
      <input
        :disabled="disabledKeyboard"
        :value="valueModel"
        type="number"
        :focus="focus"
        :maxlength="maxlength"
        class="u-input"
        @input="getVal"
      />
      <view v-for="(item, index) in loopCharArr" :key="index">
        <view
          :class="[
            breathe && charArrLength == index ? 'u-breathe' : '',
            'u-char-item',
            charArrLength === index && mode == 'box' ? 'u-box-active' : '',
            mode === 'box' ? 'u-box' : '',
          ]"
          :style="{
            fontWeight: bold ? 'bold' : 'normal',
            fontSize: fontSize + 'rpx',
            width: width + 'rpx',
            height: width + 'rpx',
            color: inactiveColor,
            borderColor: charArrLength === index && mode == 'box' ? activeColor : inactiveColor,
          }"
        >
          <view
            class="u-placeholder-line"
            :style="{
              display: charArrLength === index ? 'block' : 'none',
              height: width * 0.5 + 'rpx',
            }"
            v-if="mode !== 'middleLine'"
          ></view>
          <view
            v-if="mode === 'middleLine' && charArrLength <= index"
            :class="[
              breathe && charArrLength == index ? 'u-breathe' : '',
              charArrLength === index ? 'u-middle-line-active' : '',
            ]"
            class="u-middle-line"
            :style="{
              height: bold ? '4px' : '2px',
              background: charArrLength === index ? activeColor : inactiveColor,
            }"
          ></view>
          <view
            v-if="mode === 'bottomLine'"
            :class="[
              breathe && charArrLength == index ? 'u-breathe' : '',
              charArrLength === index ? 'u-buttom-line-active' : '',
            ]"
            class="u-bottom-line"
            :style="{
              height: bold ? '4px' : '2px',
              background: charArrLength === index ? activeColor : inactiveColor,
            }"
          ></view>
          <block v-if="!dotFill"> {{ charArr[index] ? charArr[index] : "" }}</block>
          <block v-else>
            <text class="u-dot">{{ charArr[index] ? "●" : "" }}</text>
          </block>
        </view>
      </view>
    </view>
  </view>
</template>

<script lang='ts'>
/**
 * messageInput 验证码输入框
 * @description 该组件一般用于验证用户短信验证码的场景，也可以结合uView的键盘组件使用
 * @tutorial https://www.uviewui.com/components/messageInput.html
 * @property {String Number} maxlength 输入字符个数（默认4）
 * @property {Boolean} dot-fill 是否用圆点填充（默认false）
 * @property {String} mode 模式选择，见上方"基本使用"说明（默认box）
 * @property {String Number} value 预置值
 * @property {Boolean} breathe 是否开启呼吸效果，见上方说明（默认true）
 * @property {Boolean} focus 是否自动获取焦点（默认false）
 * @property {Boolean} bold 字体和输入横线是否加粗（默认true）
 * @property {String Number} font-size 字体大小，单位rpx（默认60）
 * @property {String} active-color 当前激活输入框的样式（默认#2abc6d）
 * @property {String} inactive-color 非激活输入框的样式，文字颜色同此值（默认#606266）
 * @property {String | Number} width 输入框宽度，单位rpx，高等于宽（默认80）
 * @property {Boolean} disabled-keyboard 禁止点击输入框唤起系统键盘（默认false）
 * @event {Function} change 输入内容发生改变时触发，具体见官网说明
 * @event {Function} finish 输入字符个数达maxlength值时触发，见官网说明
 * @example <u-message-input mode="bottomLine"></u-message-input>
 */
import { defineComponent, computed, reactive, toRefs, watch } from "vue";

export default defineComponent({
  name: "u-message-input",

  props: {
    // 最大输入长度
    maxlength: {
      type: [Number, String],
      default: 4,
    },
    // 是否用圆点填充
    dotFill: {
      type: Boolean,
      default: false,
    },
    // 显示模式，box-盒子模式，bottomLine-横线在底部模式，middleLine-横线在中部模式
    mode: {
      type: String,
      default: "box",
    },
    // 预置值
    value: {
      type: [String, Number],
      default: "",
    },
    // 当前激活输入item，是否带有呼吸效果
    breathe: {
      type: Boolean,
      default: true,
    },
    // 是否自动获取焦点
    focus: {
      type: Boolean,
      default: false,
    },
    // 字体是否加粗
    bold: {
      type: Boolean,
      default: false,
    },
    // 字体大小
    fontSize: {
      type: [String, Number],
      default: 60,
    },
    // 激活样式
    activeColor: {
      type: String,
      default: "#2abc6d",
    },
    // 未激活的样式
    inactiveColor: {
      type: String,
      default: "#606266",
    },
    // 输入框的大小，单位rpx，宽等于高
    width: {
      type: [Number, String],
      default: "80",
    },
    // 是否隐藏原生键盘，如果想用自定义键盘的话，需设置此参数为true
    disabledKeyboard: {
      type: Boolean,
      default: false,
    },
  },

  emits: ["change", "finish"],

  setup(props: any, { emit }) {
    let state: any = reactive({
      valueModel: "",
    });

    watch(
      () => props.value,
      (newVal, oldVal) => {
        // 转为字符串
        newVal = String(newVal);
        // 超出部分截掉
        state.valueModel = newVal.substring(0, props.maxlength);
      }
    );

    // 是否显示呼吸灯效果
    const animationClass = computed(() => {
      return (index) => {
        if (props.breathe && props.charArr.length == index) return "u-breathe";
        else return "";
      };
    });

    // 用于显示字符
    const charArr = computed(() => {
      return state.valueModel.split("");
    });

    const charArrLength = computed(() => {
      return state.valueModel.split("").length;
    });

    // 根据长度，循环输入框的个数，因为头条小程序数值不能用于v-for
    const loopCharArr = computed(() => {
      return new Array(props.maxlength);
    });

    function getVal(e) {
      let { value } = e.detail;
      state.valueModel = value;
      // 判断长度是否超出了maxlength值，理论上不会发生，因为input组件设置了maxlength属性值
      if (String(value).length > props.maxlength) return;
      // 未达到maxlength之前，发送change事件，达到后发送finish事件
      emit("change", value);
      if (String(value).length == props.maxlength) {
        emit("finish", value);
      }
    }

    return {
      ...toRefs(state),
      ...toRefs(props),
      animationClass,
      charArr,
      charArrLength,
      loopCharArr,
      getVal,
    };
  },
});
</script>

<style scoped lang="scss">
@import "../../libs/css/style.components.scss";

@keyframes breathe {
  0% {
    opacity: 0.3;
  }

  50% {
    opacity: 1;
  }

  100% {
    opacity: 0.3;
  }
}

.u-char-box {
  text-align: center;
}

.u-char-flex {
  @include vue-flex;

  position: relative;
  flex-wrap: wrap;
  justify-content: center;
}

.u-input {
  position: absolute;
  top: 0;
  left: -100%;
  z-index: 9;
  width: 200%;
  height: 100%;
  text-align: left;
  background: none;
  opacity: 0;
}

.u-char-item {
  position: relative;
  align-items: center;
  justify-content: center;
  width: 90rpx;
  height: 90rpx;
  margin: 10rpx 10rpx;
  font-size: 60rpx;
  font-weight: bold;
  line-height: 90rpx;
  color: $u-main-color;
  @include vue-flex;
}

.u-box {
  box-sizing: border-box;
  border: 2rpx solid #ccc;
  border-radius: 6rpx;
}

.u-box-active {
  overflow: hidden;
  border: 2rpx solid $u-type-primary;
  animation-duration: 1500 ms;
  animation-timing-function: ease-in-out;
  animation-iteration-count: infinite;
  animation-direction: alternate;
}

.u-middle-line-active {
  background: $u-type-primary;
}

.u-breathe {
  animation: breathe 2s infinite ease;
}

.u-placeholder-line {
  /* #endif */
  position: absolute;
  top: 50%;
  left: 50%;

  /* #ifndef APP-NVUE */
  display: none;
  width: 2rpx;
  height: 40rpx;
  background: #333;
  transform: translate(-50%, -50%);
  animation: twinkling 1.5s infinite ease;
}

.u-animation-breathe {
  animation-name: breathe;
}

.u-dot {
  font-size: 34rpx;
  line-height: 34rpx;
}

.u-middle-line {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80%;
  height: 4px;
  background: #000;
  border: none;
  border-radius: 2px;
  transform: translate(-50%, -50%);
}

.u-buttom-line-active {
  background: $u-type-primary;
}

.u-bottom-line {
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 80%;
  height: 4px;
  background: #000;
  border-radius: 2px;
  transform: translate(-50%);
}
</style>
